<!DOCTYPE html>
<html>
  <head>
    <title>Yaman's Iron Man Particles</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <script>
      AFRAME.registerComponent('iron-man-particles', {
        schema: {
          count: { type: 'int', default: 20000 }
        },

        init: function () {
          this.count = this.data.count;
          
          // --- 1. SETUP PARTICLES ---
          this.geometry = new THREE.BufferGeometry();
          this.positions = new Float32Array(this.count * 3);
          this.homePositions = new Float32Array(this.count * 3); // Jahan particles wapas jayenge
          this.colors = new Float32Array(this.count * 3);

          for (let i = 0; i < this.count; i++) {
            const i3 = i * 3;
            // Particles ko hawa mein faila do (Floating Dust)
            this.homePositions[i3] = (Math.random() - 0.5) * 8;
            this.homePositions[i3+1] = (Math.random() - 0.5) * 4 + 1.6;
            this.homePositions[i3+2] = (Math.random() - 0.5) * 4 - 2;

            this.positions[i3] = this.homePositions[i3];
            this.positions[i3+1] = this.homePositions[i3+1];
            this.positions[i3+2] = this.homePositions[i3+2];

            // Gold/Energy Color
            this.colors[i3] = 0.2; // R
            this.colors[i3+1] = 0.8; // G
            this.colors[i3+2] = 1.0; // B
          }

          this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
          this.geometry.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));

          const material = new THREE.PointsMaterial({
            size: 0.02,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            depthWrite: false
          });

          this.mesh = new THREE.Points(this.geometry, material);
          this.el.setObject3D('mesh', this.mesh);

          // --- 2. HAND VECTORS (Important Fix) ---
          this.leftHandEl = document.querySelector('#leftHand');
          this.rightHandEl = document.querySelector('#rightHand');
          
          // Ye vectors store karenge asli position
          this.leftVec = new THREE.Vector3();
          this.rightVec = new THREE.Vector3();
        },

        tick: function (t, dt) {
          const positions = this.geometry.attributes.position.array;
          
          // --- 3. GET WORLD POSITION (The Magic Fix) ---
          // Hum seedha position nahi lenge, hum World Position mangenge
          if (this.leftHandEl && this.leftHandEl.object3D) {
             this.leftHandEl.object3D.getWorldPosition(this.leftVec);
          }
          if (this.rightHandEl && this.rightHandEl.object3D) {
             this.rightHandEl.object3D.getWorldPosition(this.rightVec);
          }

          // --- 4. PARTICLE LOGIC ---
          for (let i = 0; i < this.count; i++) {
            const i3 = i * 3;
            let px = positions[i3];
            let py = positions[i3+1];
            let pz = positions[i3+2];

            // Target = Home Position (Default)
            let tx = this.homePositions[i3];
            let ty = this.homePositions[i3+1];
            let tz = this.homePositions[i3+2];

            // --- RIGHT HAND: MAGNET (Attract) ---
            // Distance check
            const dxR = this.rightVec.x - px;
            const dyR = this.rightVec.y - py;
            const dzR = this.rightVec.z - pz;
            const distR = Math.sqrt(dxR*dxR + dyR*dyR + dzR*dzR);

            if (distR < 0.5) { // Agar 0.5 meter ke daayre mein hai (Hand ke pass)
               // Particle ko haath ki taraf kheencho
               tx = this.rightVec.x;
               ty = this.rightVec.y;
               tz = this.rightVec.z;
               
               // Thoda Randomness (Electric Effect)
               tx += (Math.random() - 0.5) * 0.2;
               ty += (Math.random() - 0.5) * 0.2;
               tz += (Math.random() - 0.5) * 0.2;
            }

            // --- LEFT HAND: REPULSOR (Push) ---
            const dxL = px - this.leftVec.x;
            const dyL = py - this.leftVec.y;
            const dzL = pz - this.leftVec.z;
            const distL = Math.sqrt(dxL*dxL + dyL*dyL + dzL*dzL);

            if (distL < 0.5) { // Agar Left hand ke pass hai
               // Blast away!
               tx = px + dxL * 5; 
               ty = py + dyL * 5;
               tz = pz + dzL * 5;
            }

            // --- MOVE PARTICLE (Lerp for smoothness) ---
            positions[i3]   += (tx - px) * 0.1; // 10% movement per frame
            positions[i3+1] += (ty - py) * 0.1;
            positions[i3+2] += (tz - pz) * 0.1;
          }

          this.geometry.attributes.position.needsUpdate = true;
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity environment="preset: starry; groundColor: #111; grid: none"></a-entity>

      <a-entity iron-man-particles></a-entity>

      <a-entity id="leftHand" hand-tracking-controls="hand: left">
         <a-sphere radius="0.1" color="red" wireframe="true" opacity="0.5"></a-sphere>
      </a-entity>
      
      <a-entity id="rightHand" hand-tracking-controls="hand: right">
         <a-sphere radius="0.1" color="green" wireframe="true" opacity="0.5"></a-sphere>
      </a-entity>

      <a-text value="Right Hand (Green) = Attract \n Left Hand (Red) = Repel" position="0 2.5 -3" align="center" color="#FFF"></a-text>
      
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
