<!DOCTYPE html>
<html>
  <head>
    <title>Yaman's Controlled Particles</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <script>
      AFRAME.registerComponent('particle-master', {
        schema: {
          count: { type: 'int', default: 15000 },
          color: { type: 'color', default: '#00FFFF' }
        },

        init: function () {
          this.currentShapeIndex = 0;
          this.shapes = []; 
          this.lastTriggerTime = 0;

          // Hands Setup
          this.leftHand = document.querySelector('#leftHand');
          this.rightHand = document.querySelector('#rightHand');
          this.debugText = document.querySelector('#debugText');

          // --- THREE.JS SETUP ---
          const particleCount = this.data.count;
          this.geometry = new THREE.BufferGeometry();
          this.positions = new Float32Array(particleCount * 3);
          this.targetPositions = new Float32Array(particleCount * 3);
          
          for (let i = 0; i < particleCount * 3; i++) {
            this.positions[i] = (Math.random() - 0.5) * 2; // Thoda paas-paas start ho
            this.targetPositions[i] = this.positions[i];
          }

          this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));

          this.material = new THREE.PointsMaterial({
            color: this.data.color,
            size: 0.015,
            transparent: true,
            opacity: 0.9,
            blending: THREE.AdditiveBlending,
            depthWrite: false
          });

          this.particleSystem = new THREE.Points(this.geometry, this.material);
          this.el.setObject3D('mesh', this.particleSystem);

          // Shapes Generate kar lo
          this.generateShapes();
        },

        generateShapes: function() {
          const count = this.data.count;
          
          // 1. Sphere
          const sphere = [];
          for (let i = 0; i < count; i++) {
            const r = 0.8;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            sphere.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
          }
          this.shapes.push(sphere);

          // 2. Cube
          const cube = [];
          for (let i = 0; i < count; i++) {
             cube.push((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5);
          }
          this.shapes.push(cube);

          // 3. Heart
          const heart = [];
          for (let i = 0; i < count; i++) {
             let t = Math.random() * Math.PI * 2;
             let r = 0.04; 
             let x = 16 * Math.pow(Math.sin(t), 3);
             let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
             heart.push(x * r, y * r + 0.5, (Math.random()-0.5)*0.5);
          }
          this.shapes.push(heart);
        },

        nextShape: function() {
          const now = Date.now();
          if (now - this.lastTriggerTime < 1500) return; // 1.5 sec delay taaki bar bar change na ho
          this.lastTriggerTime = now;

          this.currentShapeIndex = (this.currentShapeIndex + 1) % this.shapes.length;
          const newShape = this.shapes[this.currentShapeIndex];
          
          for(let i=0; i < this.targetPositions.length; i++) {
             this.targetPositions[i] = newShape[i];
          }
          
          // Visual Feedback: Color change
          this.material.color.setHSL(Math.random(), 1, 0.5);
        },

        tick: function (t, dt) {
          if (!this.leftHand || !this.rightHand) return;

          const leftObj = this.leftHand.object3D;
          const rightObj = this.rightHand.object3D;

          // --- 1. MOVEMENT LOGIC (Fix: Only move if hand is detected) ---
          // Agar Right Hand ki position (0,0,0) nahi hai, tabhi follow karo
          if (rightObj.position.length() > 0.1) {
             // Smoothly follow right hand
             this.el.object3D.position.lerp(rightObj.position, 0.1);
          }

          // --- 2. INTERACTION LOGIC (Size & Shape) ---
          const handDistance = leftObj.position.distanceTo(rightObj.position);
          
          // Agar dono haath track ho rahe hain
          if (leftObj.position.length() > 0.1 && rightObj.position.length() > 0.1) {
             
             // Shape Change (Clap/Touch) - Distance < 10cm
             if (handDistance < 0.1) {
                this.nextShape();
             }
             
             // Size Change (Open/Close Arms)
             // Distance 0.1 se 1.0 ke beech map karenge
             let newSize = 0.005 + (handDistance * 0.03);
             if (newSize > 0.08) newSize = 0.08; 
             this.material.size = newSize;

             // Debug Text
             if(this.debugText) this.debugText.setAttribute('value', `Shape: ${this.currentShapeIndex} | Size: ${newSize.toFixed(3)}`);
          }

          // --- 3. ANIMATION LOOP (Internal Particle Movement) ---
          const positions = this.geometry.attributes.position.array;
          const speed = 3 * (dt / 1000); 

          for (let i = 0; i < positions.length; i++) {
            positions[i] += (this.targetPositions[i] - positions[i]) * speed;
          }
          this.geometry.attributes.position.needsUpdate = true;
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity environment="preset: starry; groundColor: #000; grid: none"></a-entity>

      <a-entity particle-master="count: 15000; color: #00FFFF" position="0 1.5 -0.5"></a-entity>

      <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
      <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>

      <a-text id="debugText" value="Right Hand = Move | Clap = Morph" position="0 2.5 -2" align="center" color="#FFF"></a-text>
      
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
