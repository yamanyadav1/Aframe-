<!DOCTYPE html>
<html>
  <head>
    <title>Yaman's Hand-Clap Morphing</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <script>
      AFRAME.registerComponent('particle-morpher', {
        schema: {
          count: { type: 'int', default: 15000 },
          color: { type: 'color', default: '#00FFFF' }
        },

        init: function () {
          this.currentShapeIndex = 0;
          this.shapes = []; 
          this.lastClapTime = 0; // Debounce ke liye (Taaki ek saath 50 baar na badle)

          // 1. Hands ke references le lo (Touch detect karne ke liye)
          this.leftHand = document.querySelector('#leftHand');
          this.rightHand = document.querySelector('#rightHand');

          // 2. Three.js Particle System Setup
          const particleCount = this.data.count;
          this.geometry = new THREE.BufferGeometry();
          this.positions = new Float32Array(particleCount * 3);
          this.targetPositions = new Float32Array(particleCount * 3);
          
          for (let i = 0; i < particleCount * 3; i++) {
            this.positions[i] = (Math.random() - 0.5) * 10;
            this.targetPositions[i] = this.positions[i];
          }

          this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));

          const material = new THREE.PointsMaterial({
            color: this.data.color,
            size: 0.03,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            depthWrite: false
          });

          this.particleSystem = new THREE.Points(this.geometry, material);
          this.el.setObject3D('mesh', this.particleSystem);

          // 3. Pre-Calculate Shapes
          this.generateShapes();
        },

        generateShapes: function() {
          const count = this.data.count;
          
          // Shape 0: Sphere
          const sphere = [];
          for (let i = 0; i < count; i++) {
            const r = 1.5;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            sphere.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
          }
          this.shapes.push(sphere);

          // Shape 1: Heart â¤ï¸
          const heart = [];
          for (let i = 0; i < count; i++) {
             let t = Math.random() * Math.PI * 2;
             let r = 0.1; 
             let x = 16 * Math.pow(Math.sin(t), 3);
             let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
             heart.push(x * r, y * r + 1.5, (Math.random()-0.5)*2);
          }
          this.shapes.push(heart);

          // Shape 2: Saturn ðŸª
          const saturn = [];
          for (let i = 0; i < count; i++) {
            const isRing = Math.random() > 0.4;
            if (isRing) {
               const angle = Math.random() * Math.PI * 2;
               const radius = 2 + Math.random() * 1.5;
               saturn.push(Math.cos(angle) * radius, (Math.random()-0.5)*0.1, Math.sin(angle) * radius);
            } else {
               const r = 0.8;
               saturn.push((Math.random()-0.5)*r, (Math.random()-0.5)*r, (Math.random()-0.5)*r); // Simple cloud center
            }
          }
          this.shapes.push(saturn);
          
          // Shape 3: DNA Helix ðŸ§¬
          const dna = [];
          for (let i = 0; i < count; i++) {
            const t = (i / count) * Math.PI * 20;
            const y = (i / count) * 6 - 3;
            const offset = i % 2 === 0 ? 0 : Math.PI; 
            dna.push(Math.cos(t + offset), y + 1.5, Math.sin(t + offset));
          }
          this.shapes.push(dna);
        },

        nextShape: function() {
          const now = Date.now();
          // 1 second ka delay taaki ek clap mein 10 baar change na ho
          if (now - this.lastClapTime < 1000) return; 
          this.lastClapTime = now;

          this.currentShapeIndex = (this.currentShapeIndex + 1) % this.shapes.length;
          const newShape = this.shapes[this.currentShapeIndex];
          
          for(let i=0; i < this.targetPositions.length; i++) {
             this.targetPositions[i] = newShape[i];
          }
        },

        tick: function (t, dt) {
          // --- CLAP DETECTION LOGIC ---
          if (this.leftHand && this.rightHand) {
            const leftPos = this.leftHand.object3D.position;
            const rightPos = this.rightHand.object3D.position;
            
            // Check distance (Agar distance < 0.15 meters hai, matlab hands touch ho rahe hain)
            // LeftPos.length() check isliye hai taaki agar hands track nahi ho rahe (0,0,0) toh auto-trigger na ho
            if (leftPos.length() > 0.1 && leftPos.distanceTo(rightPos) < 0.15) {
               this.nextShape();
            }
          }

          // --- ANIMATION ---
          const positions = this.geometry.attributes.position.array;
          const speed = 3 * (dt / 1000); 

          for (let i = 0; i < positions.length; i++) {
            positions[i] += (this.targetPositions[i] - positions[i]) * speed;
          }

          this.el.object3D.rotation.y += 0.001;
          this.geometry.attributes.position.needsUpdate = true;
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity environment="preset: starry; groundColor: #111; grid: none"></a-entity>

      <a-entity particle-morpher="count: 15000; color: #00FFFF" position="0 1 -2"></a-entity>

      <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
      <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>
      
      <a-text value="Touch Hands (Clap) to Change Shape" position="0 2.5 -3" align="center" color="white"></a-text>

      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
