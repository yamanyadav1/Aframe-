<!DOCTYPE html>
<html>
  <head>
    <title>Yaman's Galaxy Force</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <script>
      AFRAME.registerComponent('galaxy-system', {
        schema: {
          count: { type: 'int', default: 20000 }
        },

        init: function () {
          this.particleCount = this.data.count;
          
          // --- 1. SETUP GEOMETRY ---
          this.geometry = new THREE.BufferGeometry();
          this.positions = new Float32Array(this.particleCount * 3);
          this.colors = new Float32Array(this.particleCount * 3);
          
          // "Home" positions (Jahan particles wapas aayenge)
          this.homePositions = new Float32Array(this.particleCount * 3);

          for (let i = 0; i < this.particleCount; i++) {
            const i3 = i * 3;
            // Spread particles in a wide area
            this.homePositions[i3] = (Math.random() - 0.5) * 10;
            this.homePositions[i3+1] = (Math.random() - 0.5) * 5 + 1.6; // Eye level height
            this.homePositions[i3+2] = (Math.random() - 0.5) * 5 - 2;

            // Current positions start at home
            this.positions[i3] = this.homePositions[i3];
            this.positions[i3+1] = this.homePositions[i3+1];
            this.positions[i3+2] = this.homePositions[i3+2];

            // Color (Gold/Cyan mix)
            this.colors[i3] = Math.random();
            this.colors[i3+1] = 0.8;
            this.colors[i3+2] = 1.0;
          }

          this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
          this.geometry.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));

          const material = new THREE.PointsMaterial({
            size: 0.04,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            depthWrite: false
          });

          this.mesh = new THREE.Points(this.geometry, material);
          this.el.setObject3D('mesh', this.mesh);

          // --- 2. HAND REFERENCES ---
          this.leftHand = document.querySelector('#leftHand');
          this.rightHand = document.querySelector('#rightHand');
          
          // Mouse Fallback for PC
          this.mousePos = new THREE.Vector3(0, 0, 0);
          this.useMouse = false;
          
          window.addEventListener('mousemove', (e) => {
             this.useMouse = true;
             // Simple mouse mapping to 3D space approx
             this.mousePos.x = (e.clientX / window.innerWidth) * 10 - 5;
             this.mousePos.y = -(e.clientY / window.innerHeight) * 10 + 5;
             this.mousePos.z = -3;
          });
        },

        tick: function (t, dt) {
          const positions = this.geometry.attributes.position.array;
          const count = this.particleCount;

          // Get Hand Positions safely
          let attractPos = null; // Right Hand (Magnet)
          let repelPos = null;   // Left Hand (Bomb)

          if (this.rightHand && this.rightHand.object3D.position.length() > 0.1) {
             attractPos = this.rightHand.object3D.position;
          } else if (this.useMouse) {
             attractPos = this.mousePos; // PC Fallback
          }

          if (this.leftHand && this.leftHand.object3D.position.length() > 0.1) {
             repelPos = this.leftHand.object3D.position;
          }

          // --- 3. THE LOOP ---
          for (let i = 0; i < count; i++) {
            const i3 = i * 3;
            let px = positions[i3];
            let py = positions[i3+1];
            let pz = positions[i3+2];

            // Default: Float back to Home Position slowly
            let tx = this.homePositions[i3];
            let ty = this.homePositions[i3+1];
            let tz = this.homePositions[i3+2];

            // LOGIC A: ATTRACTION (Right Hand - Tornado Effect)
            if (attractPos) {
               const dx = attractPos.x - px;
               const dy = attractPos.y - py;
               const dz = attractPos.z - pz;
               const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

               if (dist < 4.0) { // Agar 4 meter ke range mein hai
                  // Pull towards hand
                  tx = attractPos.x;
                  ty = attractPos.y;
                  tz = attractPos.z;
                  
                  // Add Swirl (Rotation)
                  // Ye magic hai: Positions ko twist kar raha hu hand ke around
                  const angle = 0.05; // Swirl speed
                  const oldX = px - attractPos.x;
                  const oldZ = pz - attractPos.z;
                  tx += oldX * Math.cos(angle) - oldZ * Math.sin(angle);
                  tz += oldX * Math.sin(angle) + oldZ * Math.cos(angle);
               }
            }

            // LOGIC B: REPULSION (Left Hand - Push Away)
            if (repelPos) {
               const dx = px - repelPos.x;
               const dy = py - repelPos.y;
               const dz = pz - repelPos.z;
               const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

               if (dist < 1.5) { // 1.5 meter blast radius
                  // Push away hard!
                  tx = px + (dx / dist) * 2.0;
                  ty = py + (dy / dist) * 2.0;
                  tz = pz + (dz / dist) * 2.0;
               }
            }

            // --- APPLY MOVEMENT (Smooth Lerp) ---
            // Current se Target ki taraf 5% har frame mein move karo
            positions[i3]   += (tx - px) * 0.05;
            positions[i3+1] += (ty - py) * 0.05;
            positions[i3+2] += (tz - pz) * 0.05;
          }

          this.geometry.attributes.position.needsUpdate = true;
          
          // Rotate whole system slightly for cinematic feel
          this.el.object3D.rotation.y += 0.001;
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity environment="preset: starry; groundColor: #000; grid: none; skyType: atmosphere"></a-entity>

      <a-entity galaxy-system></a-entity>

      <a-entity id="rightHand" hand-tracking-controls="hand: right">
         <a-sphere radius="0.05" color="#00FF00" opacity="0.6" transparent="true"></a-sphere>
         <a-light type="point" color="#00FF00" intensity="0.5" distance="2"></a-light>
      </a-entity>

      <a-entity id="leftHand" hand-tracking-controls="hand: left">
         <a-sphere radius="0.05" color="#FF0000" opacity="0.6" transparent="true"></a-sphere>
         <a-light type="point" color="#FF0000" intensity="0.5" distance="2"></a-light>
      </a-entity>

      <a-text value="Right Hand (Green) = Tornado \n Left Hand (Red) = Blast" position="0 2.5 -3" align="center" color="#FFF"></a-text>
      
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
